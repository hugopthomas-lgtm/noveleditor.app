<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Editor - Book Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script>window.PagedConfig = { auto: false };</script>
    <script src="https://unpkg.com/pagedjs@0.4.3/dist/paged.polyfill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'EB Garamond', Georgia, serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2a2522;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* ===== LOADING ===== */
        .loading {
            color: #a0a0a0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            text-align: center;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(167,139,250,0.2);
            border-top-color: #a78bfa;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-step {
            margin-top: 8px;
            font-size: 12px;
            color: #777;
            transition: opacity 0.3s;
        }

        .error {
            color: #ff453a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px; text-align: center; max-width: 400px;
        }

        /* ===== PAGED.JS RENDER (hidden off-screen) ===== */
        #paged-render {
            position: absolute;
            left: -99999px;
            top: 0;
            visibility: hidden;
            z-index: -1;
        }

        /* ===== BOOK CONTAINER ===== */
        #book-container {
            display: none;
            position: relative;
        }
        #book-container.visible { display: block; }

        /* ===== PAGE STYLING ===== */
        .page {
            background: #faf6f0;
            overflow: hidden;
            position: relative;
        }
        .page.hard { background: #faf6f0; }

        /* Page edge effect — subtle shadow on inner edge */
        .page::after {
            content: '';
            position: absolute;
            top: 0; bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 5;
        }
        .page.page-recto::after {
            left: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.06), transparent);
        }
        .page.page-verso::after {
            right: 0;
            background: linear-gradient(to left, rgba(0,0,0,0.06), transparent);
        }

        .page-inner {
            padding: 48px 38px 58px 48px;
            height: 100%;
            display: flex;
            flex-direction: column;
            font-family: 'EB Garamond', Georgia, serif;
            overflow: hidden;
        }
        .page-inner.recto { padding: 48px 48px 58px 38px; }

        /* ===== COVER — Gallimard inspired ===== */
        .cover-page {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; height: 100%;
            padding: 40px 30px; position: relative;
        }
        .cover-border {
            position: absolute; inset: 12px;
            border: 2px solid #c0392b; pointer-events: none;
        }
        .cover-border-inner {
            position: absolute; inset: 16px;
            border: 1px solid #2a2522; pointer-events: none;
        }
        .cover-author {
            font-size: 14px; letter-spacing: 2px;
            text-transform: uppercase; color: #2a2522;
            margin-bottom: 24px; font-weight: 400;
        }
        .cover-title {
            font-size: 28px; font-weight: 600; color: #2a2522;
            line-height: 1.3; letter-spacing: 1px;
            font-variant: small-caps; margin-bottom: 16px;
        }
        .cover-ornament {
            color: #c0392b; font-size: 20px;
            letter-spacing: 6px; margin: 12px 0;
        }
        .cover-subtitle {
            font-size: 13px; color: #666;
            font-style: italic; letter-spacing: 1px;
        }
        .cover-imprint {
            position: absolute; bottom: 30px;
            font-size: 10px; letter-spacing: 3px;
            color: #999; text-transform: uppercase;
        }

        /* Back cover */
        .back-cover {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; height: 100%;
            padding: 40px 30px; position: relative;
        }
        .back-cover-text { font-size: 11px; color: #999; letter-spacing: 1px; }
        .back-cover-text a { color: #a78bfa; text-decoration: none; }

        /* Title page (interior) */
        .title-page {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; height: 100%;
        }
        .title-page-ornament {
            color: #ccc; font-size: 16px;
            letter-spacing: 8px; margin: 16px 0;
        }
        .title-page-title {
            font-size: 24px; font-weight: 600; color: #2a2522;
            line-height: 1.3; margin-bottom: 8px;
        }
        .title-page-subtitle {
            font-size: 13px; color: #999; font-style: italic;
        }

        /* ===== CHAPTER CONTENT (typeset by Paged.js) ===== */
        .chapter-content {
            flex: 1;
            overflow: hidden;
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 13.5px;
            line-height: 1.65;
            color: #2a2522;
            text-align: justify;
            hyphens: auto;
            -webkit-hyphens: auto;
            orphans: 2;
            widows: 2;
        }
        .chapter-content h1 {
            font-size: 18px; font-weight: 600;
            color: #2a2522; text-align: center;
            padding-top: 40px; margin-bottom: 20px;
            letter-spacing: 0.5px; font-variant: small-caps;
            line-height: 1.4;
        }
        .chapter-content p {
            text-indent: 1.5em;
            margin: 0 0 2px 0;
        }
        .chapter-content h1 + p {
            text-indent: 0;
        }
        /* Drop cap on first paragraph after chapter title */
        .chapter-content h1 + p::first-letter {
            float: left;
            font-size: 3.4em;
            line-height: 0.78;
            padding-right: 6px;
            padding-top: 5px;
            color: #2a2522;
            font-weight: 600;
        }
        .chapter-content .scene-break {
            text-align: center;
            text-indent: 0;
            padding: 10px 0;
            color: #999;
            letter-spacing: 6px;
        }

        /* Page number */
        .page-number {
            font-size: 10.5px; color: #bbb;
            font-style: italic; margin-top: auto;
            padding-top: 12px; flex-shrink: 0;
        }
        .page-number.left { text-align: left; }
        .page-number.right { text-align: right; }

        /* ===== SPINE SHADOW ===== */
        .book-spine-shadow {
            position: absolute; top: 0; bottom: 0;
            left: 50%; transform: translateX(-50%);
            width: 60px;
            background: linear-gradient(to right,
                rgba(0,0,0,0.22) 0%, rgba(0,0,0,0.10) 15%,
                rgba(0,0,0,0) 30%, rgba(0,0,0,0.04) 50%,
                rgba(0,0,0,0) 70%, rgba(0,0,0,0.10) 85%,
                rgba(0,0,0,0.22) 100%
            );
            z-index: 100; pointer-events: none;
        }

        /* StPageFlip overrides */
        .stf__parent {
            box-shadow: 0 12px 60px rgba(0,0,0,0.6);
            border-radius: 2px;
        }
        .stf__parent .stf__item,
        .stf__parent .--soft,
        .stf__parent .--hard {
            background: #faf6f0;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            position: fixed; top: 16px; right: 16px;
            display: flex; gap: 8px; z-index: 1000;
        }
        .toolbar-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.08);
            color: #bbb; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }
        .toolbar-btn:hover { background: rgba(255,255,255,0.15); color: white; }
        .toolbar-btn.active { background: rgba(167,139,250,0.3); color: #a78bfa; }

        /* ===== NAVIGATION ===== */
        .nav-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 24px; margin-top: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .nav-btn {
            padding: 8px 24px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #bbb; font-size: 13px; cursor: pointer;
            transition: all 0.2s ease; font-family: inherit;
            backdrop-filter: blur(4px);
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn:disabled { opacity: 0.2; cursor: default; }
        .nav-info { color: #777; font-size: 12px; min-width: 80px; text-align: center; }

        /* Progress bar */
        .progress-bar-container {
            width: 100%; max-width: 500px; height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px; margin-top: 12px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background: #a78bfa;
            border-radius: 2px; transition: width 0.3s ease;
        }

        /* Banner */
        .banner {
            margin-top: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 11px; color: #555;
        }
        .banner a { color: #a78bfa; text-decoration: none; }
        .banner a:hover { text-decoration: underline; }

        /* Share toast */
        .share-toast {
            position: fixed; bottom: -50px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 10px 24px; border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 13px; z-index: 2000;
            transition: bottom 0.3s ease; backdrop-filter: blur(8px);
        }
        .share-toast.visible { bottom: 24px; }
    </style>
</head>
<body>

<div class="loading" id="loading">
    <div class="loading-spinner"></div>
    Loading your book preview...
    <div class="loading-step" id="loading-step"></div>
</div>

<div class="error" id="error" style="display:none;"></div>

<!-- Paged.js renders here (off-screen) -->
<div id="paged-render"></div>

<div id="book-container">
    <div id="book"></div>
</div>

<div class="toolbar" id="toolbar" style="display:none;">
    <button class="toolbar-btn" id="btn-share" onclick="shareLink()" title="Share">&#128279;</button>
    <button class="toolbar-btn" id="btn-sound" onclick="toggleSound()" title="Toggle sound">&#128264;</button>
    <button class="toolbar-btn" id="btn-fullscreen" onclick="toggleFullscreen()" title="Fullscreen">&#x26F6;</button>
</div>
<div class="share-toast" id="share-toast">Link copied!</div>

<div class="nav-bar" id="nav-bar" style="display:none;">
    <button class="nav-btn" id="btn-prev" onclick="flipPrev()">&larr; Previous</button>
    <span class="nav-info" id="nav-info">1 / 1</span>
    <button class="nav-btn" id="btn-next" onclick="flipNext()">Next &rarr;</button>
</div>

<div class="progress-bar-container" id="progress-bar" style="display:none;">
    <div class="progress-bar-fill" id="progress-fill" style="width:0%;"></div>
</div>

<div class="banner" id="banner" style="display:none;">
    Made with <a href="https://noveleditor.app" target="_blank">Novel Editor</a>
</div>

<script>
var pageFlip = null;
var bookPages = [];
var soundEnabled = true;

// Page dimensions — Pocket format (4.25in x 6.87in)
var PAGE_W = 380;
var PAGE_H = 615;

// Page turn sound
var pageSoundData = 'data:audio/wav;base64,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';
var pageSound = new Audio(pageSoundData);
function playPageSound() {
    if (!soundEnabled) return;
    pageSound.currentTime = 0;
    pageSound.play().catch(function() {});
}

// ===== PAGED.JS CSS for pagination =====
var PAGED_CSS = '\
@page {\
  size: ' + PAGE_W + 'px ' + PAGE_H + 'px;\
  margin: 48px 38px 58px 48px;\
}\
@page :right {\
  margin: 48px 48px 58px 38px;\
}\
@page :left {\
  margin: 48px 38px 58px 48px;\
}\
h1 {\
  break-before: right;\
  page-break-before: right;\
  font-family: "EB Garamond", Georgia, serif;\
  font-size: 18px;\
  font-weight: 600;\
  text-align: center;\
  font-variant: small-caps;\
  letter-spacing: 0.5px;\
  padding-top: 40px;\
  margin-bottom: 20px;\
  line-height: 1.4;\
  color: #2a2522;\
}\
p {\
  font-family: "EB Garamond", Georgia, serif;\
  font-size: 13.5px;\
  line-height: 1.65;\
  text-align: justify;\
  text-indent: 1.5em;\
  margin: 0 0 2px 0;\
  color: #2a2522;\
  hyphens: auto;\
  -webkit-hyphens: auto;\
  orphans: 2;\
  widows: 2;\
}\
h1 + p {\
  text-indent: 0;\
}\
p.scene-break {\
  text-align: center;\
  text-indent: 0;\
  padding: 10px 0;\
  color: #999;\
  letter-spacing: 6px;\
}\
';

// ===== INIT =====
function init() {
    var params = new URLSearchParams(window.location.search);
    var token = params.get('t');
    if (!token) { showError('No preview token provided.'); return; }

    setStep('Fetching manuscript...');
    var apiBase = getApiBase();

    fetch(apiBase + '/api/preview/view/' + token)
        .then(function(res) {
            if (!res.ok) throw new Error('Preview not found');
            return res.json();
        })
        .then(function(data) {
            if (!data.content) throw new Error('Empty content');
            var content = typeof data.content === 'string' ? JSON.parse(data.content) : data.content;
            setStep('Typesetting pages...');
            return paginateWithPagedJS(content);
        })
        .then(function() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('book-container').classList.add('visible');
            document.getElementById('nav-bar').style.display = 'flex';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('banner').style.display = 'block';
        })
        .catch(function(err) {
            console.error(err);
            showError('Could not load preview. The link may have expired.');
        });
}

function getApiBase() {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:3000';
    }
    return 'https://novel-editor-server.onrender.com';
}

function setStep(text) {
    document.getElementById('loading-step').textContent = text;
}

// ===== BUILD SEMANTIC HTML FROM JSON =====
function buildContentHTML(content) {
    var html = '';
    if (content.chapters) {
        for (var i = 0; i < content.chapters.length; i++) {
            var ch = content.chapters[i];
            html += '<h1>' + escapeHtml(ch.title || 'Chapter ' + (i + 1)) + '</h1>';
            if (ch.content) {
                for (var j = 0; j < ch.content.length; j++) {
                    var para = ch.content[j].trim();
                    if (!para) continue;
                    if (/^[\*\-]{3,}$/.test(para) || para === '***' || para === '---') {
                        html += '<p class="scene-break">&middot; &middot; &middot;</p>';
                    } else {
                        html += '<p>' + escapeHtml(para) + '</p>';
                    }
                }
            }
        }
    }
    return html;
}

// ===== PAGINATE WITH PAGED.JS =====
async function paginateWithPagedJS(content) {
    var title = content.title || 'Untitled';
    var contentHTML = buildContentHTML(content);

    // Set up render target
    var renderTarget = document.getElementById('paged-render');
    renderTarget.innerHTML = contentHTML;

    // Create style element for Paged.js
    var styleEl = document.createElement('style');
    styleEl.textContent = PAGED_CSS;
    document.head.appendChild(styleEl);

    // Run Paged.js Previewer
    var Previewer = (window.Paged && window.Paged.Previewer) || window.PagedPolyfill;
    var paged;

    if (Previewer && Previewer.prototype) {
        paged = new Previewer();
    } else if (window.PagedPolyfill && window.PagedPolyfill.preview) {
        // Direct polyfill mode
        await window.PagedPolyfill.preview();
        afterPagedRendered(title, renderTarget);
        document.head.removeChild(styleEl);
        return;
    }

    if (paged) {
        await paged.preview(renderTarget.innerHTML, [PAGED_CSS], renderTarget);
        afterPagedRendered(title, renderTarget);
        document.head.removeChild(styleEl);
        return;
    }

    // Fallback: if Paged.js didn't load, use manual pagination
    console.warn('Paged.js not available, using fallback pagination');
    document.head.removeChild(styleEl);
    fallbackPaginate(content, title);
}

function afterPagedRendered(title, renderTarget) {
    setStep('Assembling book...');

    var pagedPages = renderTarget.querySelectorAll('.pagedjs_page');
    bookPages = [];

    // Cover (hard)
    bookPages.push({ type: 'cover', title: title, hard: true });
    // Blank + Title page
    bookPages.push({ type: 'blank' });
    bookPages.push({ type: 'title', title: title });

    // Content pages from Paged.js
    for (var i = 0; i < pagedPages.length; i++) {
        var pageContent = pagedPages[i].querySelector('.pagedjs_page_content');
        var html = pageContent ? pageContent.innerHTML : '';
        // Clean up Paged.js artifacts
        html = html.replace(/data-[\w-]+="[^"]*"/g, '');
        bookPages.push({ type: 'chapter', html: html, pageNum: i + 1 });
    }

    // Ensure even page count + back cover
    if (bookPages.length % 2 !== 0) {
        bookPages.push({ type: 'blank' });
    }
    bookPages.push({ type: 'back', hard: true });

    // Clean up render target
    renderTarget.innerHTML = '';

    createBook();
}

// ===== FALLBACK PAGINATION (if Paged.js fails) =====
function fallbackPaginate(content, title) {
    setStep('Assembling book...');
    bookPages = [];

    bookPages.push({ type: 'cover', title: title, hard: true });
    bookPages.push({ type: 'blank' });
    bookPages.push({ type: 'title', title: title });

    // Measure-and-split approach
    var measurer = document.createElement('div');
    measurer.style.cssText = 'position:absolute;left:-9999px;visibility:hidden;' +
        'width:' + (PAGE_W - 86) + 'px;height:' + (PAGE_H - 106) + 'px;' +
        'font-family:"EB Garamond",Georgia,serif;font-size:13.5px;line-height:1.65;' +
        'text-align:justify;hyphens:auto;overflow:hidden;padding:0;';
    document.body.appendChild(measurer);

    if (content.chapters) {
        for (var i = 0; i < content.chapters.length; i++) {
            var ch = content.chapters[i];
            var chapterHTML = '<h1 style="font-size:18px;font-weight:600;text-align:center;font-variant:small-caps;padding-top:40px;margin-bottom:20px;">' +
                escapeHtml(ch.title || 'Chapter ' + (i + 1)) + '</h1>';
            var paragraphs = ch.content || [];
            var currentHTML = chapterHTML;
            var isFirstPage = true;

            for (var j = 0; j < paragraphs.length; j++) {
                var para = paragraphs[j].trim();
                if (!para) continue;
                var pHTML;
                if (/^[\*\-]{3,}$/.test(para) || para === '***' || para === '---') {
                    pHTML = '<p style="text-align:center;text-indent:0;padding:10px 0;color:#999;letter-spacing:6px;">&middot; &middot; &middot;</p>';
                } else {
                    pHTML = '<p style="text-indent:1.5em;margin:0 0 2px 0;">' + escapeHtml(para) + '</p>';
                }

                measurer.innerHTML = currentHTML + pHTML;
                if (measurer.scrollHeight > measurer.clientHeight && currentHTML !== chapterHTML) {
                    bookPages.push({ type: 'chapter', html: currentHTML, pageNum: bookPages.length - 2 });
                    currentHTML = pHTML;
                    isFirstPage = false;
                } else {
                    currentHTML += pHTML;
                }
            }
            if (currentHTML) {
                bookPages.push({ type: 'chapter', html: currentHTML, pageNum: bookPages.length - 2 });
            }
        }
    }

    document.body.removeChild(measurer);

    if (bookPages.length % 2 !== 0) bookPages.push({ type: 'blank' });
    bookPages.push({ type: 'back', hard: true });

    createBook();
}

// ===== RENDER PAGES & CREATE BOOK =====
function renderPage(page, index) {
    var div = document.createElement('div');
    var isRecto = (index % 2 === 1); // odd pages are recto (right)
    div.className = 'page' + (page.hard ? ' hard' : '') + (isRecto ? ' page-recto' : ' page-verso');

    if (page.type === 'cover') {
        div.innerHTML =
            '<div class="cover-page">' +
            '<div class="cover-border"></div><div class="cover-border-inner"></div>' +
            '<div class="cover-author">&nbsp;</div>' +
            '<div class="cover-ornament">&#8212;</div>' +
            '<div class="cover-title">' + escapeHtml(page.title) + '</div>' +
            '<div class="cover-ornament">&#8212;</div>' +
            '<div class="cover-subtitle">A Novel</div>' +
            '<div class="cover-imprint">NOVEL EDITOR</div></div>';
    } else if (page.type === 'back') {
        div.innerHTML =
            '<div class="back-cover"><div class="cover-border"></div><div class="cover-border-inner"></div>' +
            '<div class="back-cover-text">Made with <a href="https://noveleditor.app" target="_blank">Novel Editor</a></div></div>';
    } else if (page.type === 'title') {
        div.innerHTML =
            '<div class="page-inner"><div class="title-page">' +
            '<div class="title-page-ornament">&#10045; &#10045; &#10045;</div>' +
            '<div class="title-page-title">' + escapeHtml(page.title) + '</div>' +
            '<div class="title-page-ornament">&#8212;</div>' +
            '<div class="title-page-subtitle">A Novel</div></div></div>';
    } else if (page.type === 'blank') {
        div.innerHTML = '<div class="page-inner"></div>';
    } else {
        // Chapter content page
        var side = isRecto ? 'right' : 'left';
        var innerClass = 'page-inner' + (isRecto ? ' recto' : '');
        div.innerHTML =
            '<div class="' + innerClass + '">' +
            '<div class="chapter-content">' + page.html + '</div>' +
            '<div class="page-number ' + side + '">' + page.pageNum + '</div>' +
            '</div>';
    }
    return div;
}

function createBook() {
    var container = document.getElementById('book');
    var isMobile = window.innerWidth < 600;
    var pageWidth = isMobile ? Math.min(window.innerWidth - 40, PAGE_W) : PAGE_W;
    var pageHeight = isMobile ? Math.round(pageWidth * (PAGE_H / PAGE_W)) : PAGE_H;

    pageFlip = new St.PageFlip(container, {
        width: pageWidth,
        height: pageHeight,
        showCover: true,
        mobileScrollSupport: false,
        flippingTime: 800,
        usePortrait: isMobile,
        startZIndex: 10,
        maxShadowOpacity: 0.5,
        showPageCorners: true,
        disableFlipByClick: false
    });

    var domPages = [];
    for (var i = 0; i < bookPages.length; i++) {
        domPages.push(renderPage(bookPages[i], i));
    }
    pageFlip.loadFromHTML(domPages);

    pageFlip.on('changeState', function(e) {
        if (e.data === 'flipping') playPageSound();
    });
    pageFlip.on('flip', function() { updateNav(); });

    updateNav();

    // Spine shadow
    var spine = document.createElement('div');
    spine.className = 'book-spine-shadow';
    document.getElementById('book-container').appendChild(spine);
}

// ===== UI FUNCTIONS =====
function updateNav() {
    if (!pageFlip) return;
    var current = pageFlip.getCurrentPageIndex();
    var total = pageFlip.getPageCount();
    document.getElementById('nav-info').textContent = (current + 1) + ' / ' + total;
    document.getElementById('btn-prev').disabled = (current === 0);
    document.getElementById('btn-next').disabled = (current >= total - 1);
    var progress = total > 1 ? (current / (total - 1)) * 100 : 0;
    document.getElementById('progress-fill').style.width = progress + '%';
}

function flipNext() { if (pageFlip) pageFlip.flipNext(); }
function flipPrev() { if (pageFlip) pageFlip.flipPrev(); }

function toggleSound() {
    soundEnabled = !soundEnabled;
    var btn = document.getElementById('btn-sound');
    btn.textContent = soundEnabled ? '\uD83D\uDD0A' : '\uD83D\uDD07';
    btn.classList.toggle('active', !soundEnabled);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(function() {});
    } else {
        document.exitFullscreen();
    }
}

function shareLink() {
    var url = window.location.href;
    if (navigator.share) {
        navigator.share({ title: document.title, url: url }).catch(function() {});
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(function() {
            var toast = document.getElementById('share-toast');
            toast.classList.add('visible');
            setTimeout(function() { toast.classList.remove('visible'); }, 2000);
        });
    }
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showError(msg) {
    document.getElementById('loading').style.display = 'none';
    var el = document.getElementById('error');
    el.textContent = msg;
    el.style.display = 'block';
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault(); flipNext();
    } else if (e.key === 'ArrowLeft') {
        e.preventDefault(); flipPrev();
    }
});

init();
</script>
</body>
</html>
