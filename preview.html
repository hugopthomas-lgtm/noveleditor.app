<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Editor - Book Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'EB Garamond', Georgia, serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2a2522;
            overflow-x: hidden;
        }

        .loading {
            color: #a0a0a0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            text-align: center;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(167, 139, 250, 0.2);
            border-top-color: #a78bfa;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error {
            color: #ff453a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            text-align: center;
            max-width: 400px;
        }

        /* Book wrapper */
        #book-container {
            display: none;
        }
        #book-container.visible {
            display: block;
        }

        /* Page styling */
        .page {
            background: #faf6f0;
            overflow: hidden;
            position: relative;
            box-shadow: none;
        }
        .page.hard {
            background: #faf6f0;
        }

        .page-inner {
            padding: 40px 36px 48px;
            height: 100%;
            display: flex;
            flex-direction: column;
            font-family: 'EB Garamond', Georgia, serif;
            overflow: hidden;
        }

        /* Cover page — Gallimard inspired */
        .cover-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 40px 30px;
            position: relative;
        }
        .cover-border {
            position: absolute;
            inset: 12px;
            border: 2px solid #c0392b;
            pointer-events: none;
        }
        .cover-border-inner {
            position: absolute;
            inset: 16px;
            border: 1px solid #2a2522;
            pointer-events: none;
        }
        .cover-author {
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #2a2522;
            margin-bottom: 24px;
            font-weight: 400;
        }
        .cover-title {
            font-size: 28px;
            font-weight: 600;
            color: #2a2522;
            line-height: 1.3;
            letter-spacing: 1px;
            font-variant: small-caps;
            margin-bottom: 16px;
        }
        .cover-ornament {
            color: #c0392b;
            font-size: 20px;
            letter-spacing: 6px;
            margin: 12px 0;
        }
        .cover-subtitle {
            font-size: 13px;
            color: #666;
            font-style: italic;
            letter-spacing: 1px;
        }
        .cover-imprint {
            position: absolute;
            bottom: 30px;
            font-size: 10px;
            letter-spacing: 3px;
            color: #999;
            text-transform: uppercase;
        }

        /* Back cover */
        .back-cover {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 40px 30px;
            position: relative;
        }
        .back-cover-text {
            font-size: 11px;
            color: #999;
            letter-spacing: 1px;
        }
        .back-cover-text a {
            color: #a78bfa;
            text-decoration: none;
        }

        /* Title page (interior) */
        .title-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
        }
        .title-page-ornament {
            color: #ccc;
            font-size: 16px;
            letter-spacing: 8px;
            margin: 16px 0;
        }
        .title-page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2a2522;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        .title-page-subtitle {
            font-size: 13px;
            color: #999;
            font-style: italic;
        }

        /* Chapter content */
        .chapter-title {
            font-size: 18px;
            font-weight: 600;
            color: #2a2522;
            margin-bottom: 20px;
            text-align: center;
            padding-top: 40px;
            letter-spacing: 0.5px;
            font-variant: small-caps;
        }
        .chapter-text {
            font-size: 13.5px;
            line-height: 1.5;
            color: #2a2522;
            text-align: justify;
            hyphens: auto;
            flex: 1;
            orphans: 2;
            widows: 2;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .chapter-text p {
            text-indent: 1.5em;
            margin-bottom: 0;
        }
        .chapter-text p:first-child {
            text-indent: 0;
        }
        .chapter-text p.first-para::first-letter {
            float: left;
            font-size: 3.2em;
            line-height: 0.8;
            padding-right: 4px;
            padding-top: 4px;
            color: #2a2522;
            font-weight: 600;
        }
        .chapter-text .scene-break {
            text-align: center;
            text-indent: 0;
            padding: 8px 0;
            color: #999;
            letter-spacing: 6px;
        }

        /* Page number */
        .page-number {
            font-size: 11px;
            color: #bbb;
            font-style: italic;
            margin-top: auto;
            padding-top: 16px;
            flex-shrink: 0;
        }
        .page-number.left { text-align: left; }
        .page-number.right { text-align: right; }

        /* Toolbar */
        .toolbar {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }
        .toolbar-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.08);
            color: #bbb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }
        .toolbar-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        .toolbar-btn.active {
            background: rgba(167, 139, 250, 0.3);
            color: #a78bfa;
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .nav-btn {
            padding: 8px 24px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #bbb;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            backdrop-filter: blur(4px);
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-btn:disabled {
            opacity: 0.2;
            cursor: default;
        }
        .nav-info {
            color: #777;
            font-size: 12px;
            min-width: 80px;
            text-align: center;
        }

        /* Progress bar */
        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #a78bfa;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Banner */
        .banner {
            margin-top: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 11px;
            color: #555;
        }
        .banner a {
            color: #a78bfa;
            text-decoration: none;
        }
        .banner a:hover { text-decoration: underline; }

        /* Share toast */
        .share-toast {
            position: fixed;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 13px;
            z-index: 2000;
            transition: bottom 0.3s ease;
            backdrop-filter: blur(8px);
        }
        .share-toast.visible {
            bottom: 24px;
        }

        /* StPageFlip overrides */
        .stf__parent {
            box-shadow: 0 10px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            clip-path: inset(0);
            position: relative;
        }
        /* Book spine shadow */
        .stf__parent::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            background: linear-gradient(to right,
                rgba(0,0,0,0.15) 0%,
                rgba(0,0,0,0.06) 15%,
                rgba(0,0,0,0) 30%,
                rgba(0,0,0,0.02) 50%,
                rgba(0,0,0,0) 70%,
                rgba(0,0,0,0.06) 85%,
                rgba(0,0,0,0.15) 100%
            );
            z-index: 100;
            pointer-events: none;
        }
        .stf__parent .stf__item,
        .stf__parent .--soft,
        .stf__parent .--hard {
            background: #faf6f0;
            backface-visibility: hidden;
        }
    </style>
</head>
<body>

<div class="loading" id="loading">
    <div class="loading-spinner"></div>
    Loading your book preview...
</div>

<div class="error" id="error" style="display:none;"></div>

<div id="book-container">
    <div id="book"></div>
</div>

<div class="toolbar" id="toolbar" style="display:none;">
    <button class="toolbar-btn" id="btn-share" onclick="shareLink()" title="Share">&#128279;</button>
    <button class="toolbar-btn" id="btn-sound" onclick="toggleSound()" title="Toggle sound">&#128264;</button>
    <button class="toolbar-btn" id="btn-fullscreen" onclick="toggleFullscreen()" title="Fullscreen">&#x26F6;</button>
</div>
<div class="share-toast" id="share-toast">Link copied!</div>

<div class="nav-bar" id="nav-bar" style="display:none;">
    <button class="nav-btn" id="btn-prev" onclick="flipPrev()">&larr; Previous</button>
    <span class="nav-info" id="nav-info">1 / 1</span>
    <button class="nav-btn" id="btn-next" onclick="flipNext()">Next &rarr;</button>
</div>

<div class="progress-bar-container" id="progress-bar" style="display:none;">
    <div class="progress-bar-fill" id="progress-fill" style="width:0%;"></div>
</div>

<div class="banner" id="banner" style="display:none;">
    Made with <a href="https://noveleditor.app" target="_blank">Novel Editor</a>
</div>

<script>
var pageFlip = null;
var pages = [];
var soundEnabled = true;
var MAX_CHARS_PER_PAGE = 1100;

// Page turn sound using Web Audio API
var audioCtx = null;
function playPageSound() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var duration = 0.3;
    var sampleRate = audioCtx.sampleRate;
    var length = sampleRate * duration;
    var buffer = audioCtx.createBuffer(1, length, sampleRate);
    var data = buffer.getChannelData(0);
    for (var i = 0; i < length; i++) {
        var t = i / length;
        var envelope = Math.exp(-2.5 * t) * Math.sin(t * Math.PI * 0.8);
        var freq = 400 - (200 * t);
        var phase = 2 * Math.PI * freq * (i / sampleRate);
        var sine = Math.sin(phase);
        var noise = (Math.random() * 2 - 1) * 0.4;
        data[i] = (sine * 0.6 + noise * 0.4) * envelope * 0.4;
    }
    var source = audioCtx.createBufferSource();
    source.buffer = buffer;
    var filter = audioCtx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = 800;
    source.connect(filter);
    filter.connect(audioCtx.destination);
    source.start();
}

function init() {
    var params = new URLSearchParams(window.location.search);
    var token = params.get('t');

    if (!token) {
        showError('No preview token provided.');
        return;
    }

    var apiBase = getApiBase();
    fetch(apiBase + '/api/preview/view/' + token)
        .then(function(res) {
            if (!res.ok) throw new Error('Preview not found');
            return res.json();
        })
        .then(function(data) {
            if (data.content) {
                var content = typeof data.content === 'string' ? JSON.parse(data.content) : data.content;
                buildPages(content);
                createBook();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('book-container').classList.add('visible');
                document.getElementById('nav-bar').style.display = 'flex';
                document.getElementById('toolbar').style.display = 'flex';
                document.getElementById('progress-bar').style.display = 'block';
                document.getElementById('banner').style.display = 'block';
            } else {
                showError('This preview is no longer available.');
            }
        })
        .catch(function() {
            showError('Could not load preview. The link may have expired.');
        });
}

function getApiBase() {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:3000';
    }
    return 'https://novel-editor-server.onrender.com';
}

function buildPages(content) {
    var title = content.title || 'Untitled';

    // Cover page (hard)
    pages.push({ type: 'cover', title: title, hard: true });

    // Blank + Title page
    pages.push({ type: 'blank' });
    pages.push({ type: 'title', title: title });

    // Chapter pages
    if (content.chapters) {
        for (var i = 0; i < content.chapters.length; i++) {
            var chapter = content.chapters[i];
            var fullText = chapter.content.join('\n');
            var chunks = splitIntoPages(fullText, MAX_CHARS_PER_PAGE);
            for (var j = 0; j < chunks.length; j++) {
                pages.push({
                    type: 'chapter',
                    title: j === 0 ? chapter.title : null,
                    text: chunks[j],
                    isFirstPage: j === 0
                });
            }
        }
    }

    // Ensure even number + back cover
    if (pages.length % 2 !== 0) {
        pages.push({ type: 'blank' });
    }
    pages.push({ type: 'back', hard: true });
}

function splitIntoPages(text, maxChars) {
    if (text.length <= maxChars) return [text];
    var chunks = [];
    var paragraphs = text.split('\n');
    var current = '';
    for (var i = 0; i < paragraphs.length; i++) {
        var p = paragraphs[i];
        if (current.length + p.length + 1 > maxChars && current.length > 0) {
            chunks.push(current);
            current = p;
        } else {
            current += (current ? '\n' : '') + p;
        }
    }
    if (current) chunks.push(current);
    return chunks;
}

function renderPage(page, pageIndex) {
    var div = document.createElement('div');
    div.className = 'page' + (page.hard ? ' hard' : '');

    if (page.type === 'cover') {
        div.innerHTML =
            '<div class="cover-page">' +
            '<div class="cover-border"></div>' +
            '<div class="cover-border-inner"></div>' +
            '<div class="cover-author">&nbsp;</div>' +
            '<div class="cover-ornament">&#8212;</div>' +
            '<div class="cover-title">' + escapeHtml(page.title) + '</div>' +
            '<div class="cover-ornament">&#8212;</div>' +
            '<div class="cover-subtitle">A Novel</div>' +
            '<div class="cover-imprint">NOVEL EDITOR</div>' +
            '</div>';
    } else if (page.type === 'back') {
        div.innerHTML =
            '<div class="back-cover">' +
            '<div class="cover-border"></div>' +
            '<div class="cover-border-inner"></div>' +
            '<div class="back-cover-text">Made with <a href="https://noveleditor.app" target="_blank">Novel Editor</a></div>' +
            '</div>';
    } else if (page.type === 'title') {
        div.innerHTML =
            '<div class="page-inner"><div class="title-page">' +
            '<div class="title-page-ornament">&#10045; &#10045; &#10045;</div>' +
            '<div class="title-page-title">' + escapeHtml(page.title) + '</div>' +
            '<div class="title-page-ornament">&#8212;</div>' +
            '<div class="title-page-subtitle">A Novel</div>' +
            '</div></div>';
    } else if (page.type === 'blank') {
        div.innerHTML = '<div class="page-inner"></div>';
    } else {
        var html = '<div class="page-inner">';
        if (page.title) {
            html += '<div class="chapter-title">' + escapeHtml(page.title) + '</div>';
        }
        html += '<div class="chapter-text">';
        var paragraphs = page.text.split('\n');
        for (var i = 0; i < paragraphs.length; i++) {
            var p = paragraphs[i].trim();
            if (!p) continue;
            // Scene break detection
            if (/^[\*\-]{3,}$/.test(p) || p === '***' || p === '---') {
                html += '<p class="scene-break">&middot; &middot; &middot;</p>';
            } else {
                var cls = (page.isFirstPage && i === 0) ? ' class="first-para"' : '';
                html += '<p' + cls + '>' + escapeHtml(p) + '</p>';
            }
        }
        html += '</div>';

        // Page numbers (not on cover/title/first chapter page)
        if (!page.title) {
            var side = (pageIndex % 2 === 0) ? 'left' : 'right';
            html += '<div class="page-number ' + side + '">' + (pageIndex) + '</div>';
        }

        html += '</div>';
        div.innerHTML = html;
    }

    return div;
}

function createBook() {
    var container = document.getElementById('book');
    var isMobile = window.innerWidth < 600;
    var pageWidth = isMobile ? Math.min(window.innerWidth - 40, 340) : 340;
    var pageHeight = isMobile ? Math.round(pageWidth * 1.47) : 500;

    pageFlip = new St.PageFlip(container, {
        width: pageWidth,
        height: pageHeight,
        showCover: true,
        mobileScrollSupport: false,
        flippingTime: 800,
        usePortrait: isMobile,
        startZIndex: 10,
        maxShadowOpacity: 0.5,
        showPageCorners: true,
        disableFlipByClick: false
    });

    // Build DOM pages
    var domPages = [];
    for (var i = 0; i < pages.length; i++) {
        domPages.push(renderPage(pages[i], i));
    }

    pageFlip.loadFromHTML(domPages);

    // Events — sound on flip START, nav update on flip END
    pageFlip.on('changeState', function(e) {
        if (e.data === 'flipping' && soundEnabled) {
            try { playPageSound(); } catch(err) {}
        }
    });
    pageFlip.on('flip', function(e) {
        updateNav();
    });

    updateNav();
}

function updateNav() {
    if (!pageFlip) return;
    var current = pageFlip.getCurrentPageIndex();
    var total = pageFlip.getPageCount();
    document.getElementById('nav-info').textContent = (current + 1) + ' / ' + total;
    document.getElementById('btn-prev').disabled = (current === 0);
    document.getElementById('btn-next').disabled = (current >= total - 1);

    // Progress bar
    var progress = total > 1 ? ((current) / (total - 1)) * 100 : 0;
    document.getElementById('progress-fill').style.width = progress + '%';
}

function flipNext() {
    if (pageFlip) pageFlip.flipNext();
}

function flipPrev() {
    if (pageFlip) pageFlip.flipPrev();
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    var btn = document.getElementById('btn-sound');
    btn.textContent = soundEnabled ? '\uD83D\uDD0A' : '\uD83D\uDD07';
    btn.classList.toggle('active', !soundEnabled);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(function() {});
    } else {
        document.exitFullscreen();
    }
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showError(msg) {
    document.getElementById('loading').style.display = 'none';
    var el = document.getElementById('error');
    el.textContent = msg;
    el.style.display = 'block';
}

function shareLink() {
    var url = window.location.href;
    if (navigator.share) {
        navigator.share({ title: document.title, url: url }).catch(function() {});
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(function() {
            var toast = document.getElementById('share-toast');
            toast.classList.add('visible');
            setTimeout(function() { toast.classList.remove('visible'); }, 2000);
        });
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        flipNext();
    } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        flipPrev();
    }
});

init();
</script>
</body>
</html>
